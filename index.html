<!DOCTYPE html>
<html lang="zh">

<head>
  <meta charset="UTF-8">
  <title>艾宾浩斯记忆曲线复习助手</title>
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f5f5f5;
      margin: 0;
      padding: 0;
      color: #333;
    }

    header {
      background-color: #4CAF50;
      color: white;
      padding: 20px;
      text-align: center;
    }

    h1 {
      margin: 0;
    }

    .section {
      background: white;
      border-radius: 8px;
      margin: 20px;
      padding: 20px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
    }

    label {
      margin-right: 10px;
      font-size: 16px;
    }

    input,
    button {
      padding: 10px;
      margin-top: 5px;
      border-radius: 4px;
      border: 1px solid #ccc;
    }

    input[type="text"],
    input[type="date"],
    input[type="month"] {
      width: 200px;
    }

    button {
      background-color: #4CAF50;
      color: white;
      cursor: pointer;
      border: none;
    }

    button:hover {
      background-color: #45a049;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      margin-top: 20px;
    }

    th,
    td {
      padding: 6px;
      text-align: left;
      vertical-align: top;
      border: 1px solid #ddd;
      border-radius: 6px;
      font-size: 11px;
    }

    th {
      background-color: #4CAF50;
      color: white;
    }

    tr:hover {
      background-color: #f2f2f2;
    }

    .completed {
      background-color: #d0f0c0;
      text-decoration: line-through;
    }

    .completed input[type="checkbox"] {
      background-color: #d0f0c0;
    }

    #countdown,
    #todayInfo {
      margin-bottom: 20px;
      font-size: 18px;
      font-weight: 600;
    }

    #stats {
      font-weight: bold;
      margin-top: 20px;
    }

    .card {
      background-color: #fff;
      border-radius: 8px;
      box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
      padding: 20px;
      margin: 10px 0;
    }

    .card h2 {
      margin-top: 0;
    }

    /* 进度条外框 */
    .progress-bar {
      width: 300px;
      height: 20px;
      background-color: #e0e0e0;
      /* 灰色背景 */
      border-radius: 10px;
      margin-top: 10px;
    }

    /* 进度条的实际填充部分 */
    .progress {
      height: 100%;
      background: linear-gradient(90deg, #4caf50, #8bc34a);
      /* 绿色渐变 */
      border-radius: 10px;
    }

    .highlight {
      background-color: #fff9c4;
      /* 黄色背景色 */
      font-weight: bold;
    }

    /* 警示按钮样式 */
    .warning-button {
      background-color: #f44336;
      /* 红色 */
      color: white;
      /* 白色文字 */
      border: none;
      /* 去掉边框 */
      padding: 10px 20px;
      /* 内边距 */
      font-size: 16px;
      /* 字体大小 */
      cursor: pointer;
      /* 鼠标悬停时显示为可点击 */
      border-radius: 5px;
      /* 圆角 */
      transition: background-color 0.3s;
      /* 平滑过渡 */
    }

    .warning-button:hover {
      background-color: #d32f2f;
      /* 鼠标悬停时的颜色 */
    }

    .warning-button:focus {
      outline: none;
      /* 去掉焦点时的轮廓 */
    }

    .no-task-row {
      background-image: repeating-linear-gradient(45deg,
          #f0f0f0,
          #f0f0f0 5px,
          #ffffff 5px,
          #ffffff 10px);
      opacity: 0.8;
    }

    .draggable {
      cursor: move;
    }

    .drop-target {
      border: 1px dashed transparent;
      transition: border-color 0.2s ease;
    }

    .drop-target:hover {
      border-color: #45a049;
    }
  </style>
</head>

<body>

  <header>
    <h1>艾宾浩斯记忆曲线复习助手</h1>
  </header>

  <div class="section card">
    <h2>考研倒计时</h2>
    <div id="countdown"></div>
  </div>

  <div class="section card">
    <h2>今天的日期</h2>
    <div id="todayInfo"></div>
    <button onclick="skipToday()">Skip Today</button>
    <button onclick="undoSkipToday()" style="background-color: #d3d3d3;">Undo</button>
  </div>

  <div class="section card">
    <h2>添加日程</h2>
    <label>名称：<input type="text" id="eventName"></label>
    <label>开始时间：<input type="date" id="startDate"></label>
    <button onclick="addSchedule()">添加</button>
  </div>

  <div class="section card">
    <h2>查看日程表</h2>
    <label>选择月份：
      <input type="month" id="viewMonth" onchange="renderSchedule()">
    </label>
    <div id="calendar"></div>
  </div>

  <div class="section card" id="stats">
    <!-- Progress Stats will be rendered here -->
  </div>

  <div class="section card">
    <h2>数据管理</h2>
    <h3>删除指定日程与清空</h3>
    <label>请输入日程名称：<input type="text" id="deleteEventName"></label>
    <button onclick="deleteSchedulesByName()">删除所有该名称的日程</button> <br>
    <button id="clear-all-schedules" class="warning-button">清空所有日程</button>
    <h3>备份导出</h3>
    <button onclick="downloadData()">导出数据 (JSON)</button>
    <label>
      导入数据：<input type="file" onchange="uploadData(event)">
    </label> <br>
    <button onclick="exportToICS()">导出所有日程为日历文件 (.ics)</button>
  </div>

  <script>
    const reviewOffsets = [0, 1, 3, 6, 14, 29, 44];
    let allSchedules = JSON.parse(localStorage.getItem('schedules') || '[]');

    function saveData() {
      localStorage.setItem('schedules', JSON.stringify(allSchedules));
    }

    setInterval(() => {
      downloadData();
    }, 86400000);

    function addSchedule() {
      const name = document.getElementById("eventName").value.trim();
      const startDateStr = document.getElementById("startDate").value;
      if (!name || !startDateStr) {
        alert("请填写名称和开始时间");
        return;
      }

      const startDate = new Date(startDateStr);
      let scheduleQueue = [];

      reviewOffsets.forEach((offset, index) => {
        const reviewDate = new Date(startDate);
        reviewDate.setDate(reviewDate.getDate() + offset);
        scheduleQueue.push({
          name,
          round: index + 1,
          date: reviewDate.toISOString().split('T')[0],
          completed: false
        });
      });

      scheduleQueue.forEach(schedule => {
        let currentDate = new Date(schedule.date);
        let targetDate = currentDate.toISOString().split('T')[0];

        while (allSchedules.filter(item => item.date === targetDate).length >= 4) {
          currentDate.setDate(currentDate.getDate() + 1);
          targetDate = currentDate.toISOString().split('T')[0];
        }

        allSchedules.push({
          name: schedule.name,
          round: schedule.round,
          date: targetDate,
          completed: schedule.completed
        });
      });

      saveData();
      alert("已添加日程并生成复习计划！");
      renderSchedule();
    }

    function renderSchedule() {
      const viewMonth = document.getElementById("viewMonth").value;
      if (!viewMonth) return;

      const [year, month] = viewMonth.split("-");
      const firstDay = new Date(year, month - 1, 1);
      const lastDay = new Date(year, month, 0).getDate();
      const firstDayWeekday = firstDay.getDay();

      let calendar = {};
      allSchedules.forEach((item, idx) => {
        if (item.date.startsWith(viewMonth)) {
          if (!calendar[item.date]) calendar[item.date] = [];
          calendar[item.date].push({ ...item, index: idx });
        }
      });

      const today = new Date();
      const todayStr = today.toISOString().split('T')[0];

      let html = `<table class="calendar-table"><thead><tr>`;
      ["日", "一", "二", "三", "四", "五", "六"].forEach(day => {
        html += `<th>${day}</th>`;
      });
      html += `</tr></thead><tbody>`;

      let dayCounter = 1;
      for (let row = 0; row < 5; row++) {
        html += `<tr>`;
        for (let col = 0; col < 7; col++) {
          if (row === 0 && col < firstDayWeekday) {
            html += `<td></td>`;
          } else if (dayCounter <= lastDay) {
            const dateStr = `${year}-${month}-${String(dayCounter).padStart(2, '0')}`;
            const items = calendar[dateStr] || [];
            const content = items.map(item => {
              const titleStyle = item.round === 1 ? 'style="color: #4CAF50;"' : '';
              return `<div class="${item.completed ? 'completed' : 'drop-target'} draggable" draggable="true"
                ondragstart="handleDragStart(event, ${item.index})">
                <input type="checkbox" onchange="toggleComplete(${item.index})" ${item.completed ? 'checked' : ''}>
                <span ${titleStyle}>${item.name}-R${item.round}</span>
              </div>`;
            }).join("");
            const rowClass = content ? (dateStr === todayStr ? 'highlight' : '') : 'no-task-row';

            html += `<td class="${rowClass}" ondrop="handleDrop(event, '${dateStr}')" ondragover="allowDrop(event)">
              <div style="font-weight: bold">${dayCounter}</div><br>${content}</td>`;
            dayCounter++;
          } else {
            html += `<td></td>`;
          }
        }
        html += `</tr>`;
      }
      html += `</tbody></table>`;

      document.getElementById("calendar").innerHTML = html;
      updateStats();
    }

    function handleDragStart(event, index) {
      event.dataTransfer.setData("text", index); // Store the index of the dragged item
    }

    function allowDrop(event) {
      event.preventDefault(); // Allow drop
    }

    function handleDrop(event, targetDate) {
      event.preventDefault();
      const draggedIndex = event.dataTransfer.getData("text");
      const draggedSchedule = allSchedules[draggedIndex];
      const newDate = new Date(targetDate);

      draggedSchedule.date = newDate.toISOString().split('T')[0]; // Update the date of the dragged schedule

      saveData(); // Save updated data to local storage
      renderSchedule(); // Re-render the schedule with updated dates
    }

    function toggleComplete(index) {
      allSchedules[index].completed = !allSchedules[index].completed;
      saveData();
      renderSchedule();
    }

    function updateStats() {
      const totalTasks = allSchedules.length;
      const completedTasks = allSchedules.filter(item => item.completed).length;
      const uncompletedTasks = totalTasks - completedTasks;

      // Prevent calculating the latest and earliest schedules if there are no tasks
      if (totalTasks === 0) {
        document.getElementById("stats").innerHTML = `
      <p>没有复习计划。</p>
    `;
        return;
      }

      const latestSchedule = allSchedules.reduce((latest, item) => {
        const itemDate = new Date(item.date);
        return itemDate > latest ? itemDate : latest;
      }, new Date(0));

      const earliestSchedule = allSchedules.reduce((earliest, item) => {
        const itemDate = new Date(item.date);
        return itemDate < earliest ? itemDate : earliest;
      }, new Date());

      const latestScheduleDate = latestSchedule.toISOString().split('T')[0];
      const earliestScheduleDate = earliestSchedule.toISOString().split('T')[0];

      const timeDifference = Math.floor((latestSchedule - earliestSchedule) / (1000 * 60 * 60 * 24));

      const fifthRoundSchedules = allSchedules.filter(item => item.round === 5);
      const lastFifthRound = fifthRoundSchedules.reduce((latest, item) => {
        const itemDate = new Date(item.date);
        return itemDate > latest ? itemDate : latest;
      }, new Date(0));

      const fifthRoundTimeDifference = Math.floor((lastFifthRound - earliestSchedule) / (1000 * 60 * 60 * 24));

      const todayStr = new Date().toISOString().split('T')[0];
      const todayTasks = allSchedules.filter(item => item.date === todayStr && !item.completed).length;

      const completionRate = totalTasks ? ((completedTasks / totalTasks) * 100).toFixed(2) : 0;

      const progressBarWidth = 300;
      const progressWidth = Math.round((completedTasks / totalTasks) * progressBarWidth);

      const statsHtml = `
    <p>总任务数：${totalTasks}</p>
    <p>已完成：${completedTasks} | 未完成：${uncompletedTasks}</p>
    <p style="color:#4CAF50;">最晚复习日程：${latestScheduleDate}</p>
    <p style="color:#4CAF50;">完成所有复习所需时间：${timeDifference} 天</p>
    <p style="color:#4CAF50;">完成第五轮复习所需时间：${fifthRoundTimeDifference} 天</p>
    <p>完成率：${completionRate}%</p>
    <div class="progress-bar">
      <div class="progress" style="width: ${progressWidth}px;"></div>
    </div>
    <br>
    <details>
  <summary>复习思路参考:</summary>
 <p>第一遍R1 过讲义 挖空 1<br>
      第二遍R2 做题 2<br>
      第三遍R3 讲义 4<br>
      第四遍R4 思维导图课7<br>
      第五遍R5 做题 整理自己的anki 15<br>
      第六遍R6 导图课 30<br>
      第七遍R7 导图or讲义 + 做题 排除最近五年的题目 45</p>
</details>
  `;
      document.getElementById("stats").innerHTML = statsHtml;
    }

    function downloadData() {
      const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(allSchedules, null, 2));
      const link = document.createElement('a');
      link.setAttribute("href", dataStr);
      link.setAttribute("download", "review_schedule.json");
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function uploadData(event) {
      const file = event.target.files[0];
      if (!file) return;

      const reader = new FileReader();
      reader.onload = function (e) {
        try {
          const importedData = JSON.parse(e.target.result);
          if (Array.isArray(importedData)) {
            allSchedules = importedData;
            saveData();
            alert("数据导入成功！");
            renderSchedule();
          } else {
            alert("导入的数据格式不正确！");
          }
        } catch (err) {
          alert("读取文件时出错：" + err.message);
        }
      };
      reader.readAsText(file);
    }

    function updateCountdown() {
      const examDate = new Date('2025-12-20T00:00:00+08:00');
      const now = new Date();
      const timeDifference = examDate - now;

      const days = Math.floor(timeDifference / (1000 * 60 * 60 * 24));
      const hours = Math.floor((timeDifference % (1000 * 60 * 60 * 24)) / (1000 * 60 * 60));
      const minutes = Math.floor((timeDifference % (1000 * 60 * 60)) / (1000 * 60));
      const seconds = Math.floor((timeDifference % (1000 * 60)) / 1000);

      document.getElementById("countdown").innerHTML = `
        <strong>考研倒计时：</strong> ${days}天 ${hours}小时 ${minutes}分钟 ${seconds}秒
      `;
    }

    function updateTodayInfo() {
      const today = new Date();
      const daysOfWeek = ['星期天', '星期一', '星期二', '星期三', '星期四', '星期五', '星期六'];
      const todayStr = `${today.getFullYear()}年${today.getMonth() + 1}月${today.getDate()}日`;
      const weekDay = daysOfWeek[today.getDay()];
      document.getElementById("todayInfo").innerHTML = `今天是：${todayStr} ${weekDay}`;
    }
    function exportToICS() {
      if (allSchedules.length === 0) {
        alert("暂无日程数据可导出");
        return;
      }

      let icsContent = `BEGIN:VCALENDAR
VERSION:2.0
PRODID:-//Ebbinghaus Review Helper//EN
CALSCALE:GREGORIAN
METHOD:PUBLISH
`;

      // 用来记录已添加的事件UID
      let existingUIDs = new Set();

      allSchedules.forEach(item => {
        const dateStr = item.date.replace(/-/g, '');
        // 使用全天事件的格式
        const start = `${dateStr}`;
        const end = `${dateStr}`;
        const uid = `${start}-${item.name}`; // 生成唯一的UID

        // 如果UID已存在，跳过当前事件
        if (existingUIDs.has(uid)) {
          return;
        }

        existingUIDs.add(uid);  // 添加UID到已添加集合中

        icsContent += `BEGIN:VEVENT
SUMMARY:${item.name}（第${item.round}次复习）
DTSTART;TZID=Asia/Shanghai;VALUE=DATE:${start}
DTEND;TZID=Asia/Shanghai;VALUE=DATE:${end}
DESCRIPTION:艾宾浩斯记忆曲线复习助手提醒
STATUS:CONFIRMED
SEQUENCE:0
UID:${uid}  // 为每个事件设置唯一的UID
BEGIN:VALARM
TRIGGER:-PT10M
ACTION:DISPLAY
DESCRIPTION:提醒你复习【${item.name}】
END:VALARM
END:VEVENT
`;
      });

      icsContent += `END:VCALENDAR`;

      const blob = new Blob([icsContent], { type: 'text/calendar;charset=utf-8' });
      const link = document.createElement('a');
      link.href = URL.createObjectURL(blob);
      link.download = 'review_schedule.ics';
      link.click();
    }

    // Skip Today 功能
    let previousSchedules = []; // 用于存储上次操作前的日程数据，方便恢复

    // 点击“Skip Today”按钮后，推迟所有今天及以后的日程
    function skipToday() {
      if (allSchedules.length === 0) {
        alert("暂无日程数据可操作");
        return;
      }

      // 备份当前日程数据，用于恢复
      previousSchedules = JSON.parse(JSON.stringify(allSchedules));

      const today = new Date();
      today.setHours(0, 0, 0, 0);  // 确保不包含时间部分，只有日期

      // 遍历所有日程，修改日期
      allSchedules.forEach(item => {
        const itemDate = new Date(item.date);

        // 如果日程的日期是今天或更晚，且任务未完成
        if (itemDate >= today && !item.completed) {
          // 将日期推迟一天
          itemDate.setDate(itemDate.getDate() + 1);
          item.date = itemDate.toISOString().split('T')[0];
        }
      });

      saveData(); // 保存数据到本地
      renderSchedule(); // 更新日程表
      alert("所有今天及以后日程已推迟一天！");
    }

    // 如果需要恢复，点击撤销按钮
    function undoSkipToday() {
      if (previousSchedules.length === 0) {
        alert("没有可撤销的操作");
        return;
      }

      // 恢复日程数据
      allSchedules = previousSchedules;
      saveData(); // 保存数据到本地
      renderSchedule(); // 更新日程表
      alert("操作已撤销，日程恢复到原状态");
    }

    function deleteSchedulesByName() {
      const nameToDelete = document.getElementById("deleteEventName").value.trim();

      if (!nameToDelete) {
        alert("请填写日程名称");
        return;
      }

      // Filter out all schedules with the given name and check if the schedule is not completed
      const initialScheduleCount = allSchedules.length;
      allSchedules = allSchedules.filter(schedule =>
        schedule.name !== nameToDelete || schedule.completed === true // Keep completed ones
      );

      const deletedSchedules = initialScheduleCount - allSchedules.length;

      if (deletedSchedules === 0) {
        alert("未找到匹配的日程名称，或者所有匹配的日程已完成");
      } else {
        saveData();
        alert(`已删除所有未完成的名称为 "${nameToDelete}" 的日程`);
        renderSchedule();
      }
    }

    // 清空所有日程的功能
    document.getElementById("clear-all-schedules").addEventListener("click", function () {
      const confirmClear = confirm("你确定要清空所有日程吗？此操作无法撤销！");

      if (confirmClear) {
        // 清空 allSchedules 数组
        allSchedules = [];
        // 保存数据
        saveData();
        // 更新界面
        renderSchedule();
        // 提示用户操作已完成
        alert("所有日程已清空！");
      }
    });

    window.onload = () => {
      updateCountdown();
      updateTodayInfo();

      // 设置默认的开始日期为第一轮最后一个复习日程的第二天
      const firstRoundSchedules = allSchedules.filter(item => item.round === 1);
      if (firstRoundSchedules.length > 0) {
        const lastFirstRoundSchedule = firstRoundSchedules[firstRoundSchedules.length - 1];
        const lastDate = new Date(lastFirstRoundSchedule.date); // 获取最后一个第一轮的日期
        lastDate.setDate(lastDate.getDate() + 1); // 设置为第二天

        // 填充开始日期
        document.getElementById("startDate").value = lastDate.toISOString().split('T')[0];
      }

      const today = new Date();
      const monthStr = `${today.getFullYear()}-${String(today.getMonth() + 1).padStart(2, '0')}`;
      document.getElementById("viewMonth").value = monthStr;
      renderSchedule();
    };

    setInterval(updateCountdown, 1000);
  </script>
</body>

</html>